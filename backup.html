<!--

Copyright 2015 Miguel Ortega Moreno

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->


<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/iron-icon/iron-icon.html">

<!--
Element providing solution to no problem in particular.

##### Example

<github-events></github-events>

@element github-events
@blurb Element providing solution to no problem in particular.
@status alpha
@homepage http://Mortega5.github.io/github-events
-->
<dom-module id="github-events">

  <style is="custom-style">
    :host{
      display: inline-block;
      font-family: 'Roboto';
      font-size: 5px;
    }
    .box {
      border: 5px solid #AEAEAE;
      border-top: none;
      width: 400px;
      padding:15px 5px;
      margin:0;
      font-size: 12.5px;
      background: #f2f5f6; /* Old browsers */
      background: -moz-linear-gradient(-45deg,  #f2f5f6 0%, #e3eaed 51%, #c8d7dc 100%); /* FF3.6+ */
      background: -webkit-gradient(linear, left top, right bottom, color-stop(0%,#f2f5f6), color-stop(51%,#e3eaed), color-stop(100%,#c8d7dc)); /* Chrome,Safari4+ */
      background: -webkit-linear-gradient(-45deg,  #f2f5f6 0%,#e3eaed 51%,#c8d7dc 100%); /* Chrome10+,Safari5.1+ */
      background: -o-linear-gradient(-45deg,  #f2f5f6 0%,#e3eaed 51%,#c8d7dc 100%); /* Opera 11.10+ */
      background: -ms-linear-gradient(-45deg,  #f2f5f6 0%,#e3eaed 51%,#c8d7dc 100%); /* IE10+ */
      background: linear-gradient(135deg,  #f2f5f6 0%,#e3eaed 51%,#c8d7dc 100%); /* W3C */
      filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#f2f5f6', endColorstr='#c8d7dc',GradientType=1 ); /* IE6-9 fallback on horizontal gradient */

    }

    .box:last-child {
      border-bottom-left-radius: 5px;
      border-bottom-right-radius: 5px;
      border: 5px solid #AEAEAE;
      border-top: none;
    }
    #cabecera {
      background: #dbdbdb; /* Old browsers */
      background: -moz-radial-gradient(center, ellipse cover,  #dbdbdb 0%, #a8a8a8 100%); /* FF3.6+ */
      background: -webkit-gradient(radial, center center, 0px, center center, 100%, color-stop(0%,#dbdbdb), color-stop(100%,#a8a8a8)); /* Chrome,Safari4+ */
      background: -webkit-radial-gradient(center, ellipse cover,  #dbdbdb 0%,#a8a8a8 100%); /* Chrome10+,Safari5.1+ */
      background: -o-radial-gradient(center, ellipse cover,  #dbdbdb 0%,#a8a8a8 100%); /* Opera 12+ */
      background: -ms-radial-gradient(center, ellipse cover,  #dbdbdb 0%,#a8a8a8 100%); /* IE10+ */
      background: radial-gradient(ellipse at center,  #dbdbdb 0%,#a8a8a8 100%); /* W3C */
      filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#dbdbdb', endColorstr='#a8a8a8',GradientType=1 ); /* IE6-9 fallback on horizontal gradient */

      border-top-left-radius: 5px;
      border-top-right-radius: 5px;
      color:black;
      font-family: 'Helvetica',sans-serif;
      font-weight: 800;
      font-size: 16px;
      padding: 3px 0px;
    }
    paper-shadow {
      border-bottom-left-radius: 5px;
      border-bottom-right-radius: 5px;
    }
    core-icon > div {
      background-repeat: no-repeat;
      border:none;
    }

    .imgEvent {
      float: left;
      width:40px;
      height:40px;
      margin-right: 5px;
      margin-bottom: 5px;
    }
    .imgEvent > div {
      border-radius: 100%;	
      box-shadow: 3px 3px 5px #888;
      border: 1px inset rgba(24, 41, 49, 0.67);
    }
    .name {
      font-size: 15px;
      font-weight: bold;
    }
    a {
      text-decoration: none;
      color: #160789;
    }
    a:visited {
    }
    a:hover {
      text-decoration: underline;
    }
  </style>

  <template id="template"> 
    <iron-ajax
               id="request"
               method="GET"
               url="{{events_url}}"
               params="{{events_params}}"
               handleAs="json"
               on-response="_response"
               >
    </iron-ajax>

    <iron-ajax
               id="requestLanguage"
               url="{{language_url}}"
               method="GET"
               handleAs='json'
               on-response="_language_response"
               >
    </iron-ajax>

    <iron-icon src="foto.png" style="width: 100px;height: 50px;display:inline-block;float:left"></iron-icon>
    <paper-icon-button class="boton_refrescar" style="display:inline-block; float: right; padding-top: 12px" title="{{language_data.refresh}}" icon="refresh" on-click={{refresh}}></paper-icon-button>
    <div id ="cabecera">
      <p style="padding-left: 170px">{{language_data.title}}</p>
    </div>

    <!--
<template if="{{show}}">
<ul class="box" style="border-bottom: 5px solid rgba(24, 41, 49, 0.67);cursor:wait;text-align:center">
<p>{{language_data.loading}}</p>
</ul>
</template>
-->


    <!--<div style="overflow-y: scroll;max-height: 400px" id="scrollControl">-->
    <!-- Cambiado la manera del repeat -->
    <template id="contenido" is="dom-repeat" items="events">
      <span>{{item.date}}</span>
    </template>

<template if="{{ lastPage != page && !show}}">
  <ul class="box" style="text-align:center;cursor: pointer;font-size: 16px"  on-click={{load}}>
    <span style="font-size: 12px">{{language_data.load_more}}</span>
  </ul>
</template>
<!--</div>-->

</template>

<script>


  Polymer({

    is: "github-events",
    properties: {
      per_page: {
        type: Number,
        value:15,
        notify: true,
        reflectToAttribute: true
      },
      username: {
        type: String,
        value: '',
        notify: true,
        reflectToAttribute: true
      },
      show: {
        type: Boolean,
        value: true,
      },
      page: {
        type: Number,
        value: 1,
        notify: true,
        reflectToAttribute: true
      },
      language: {
        type: String,
        value: 'es',
        notify: true,
        reflectToAttribute: true,
        observer: '_languageChanged'
      },
      language_url: {
        type: String,
        computed: '_processUrl(idioma)'
      },
      events_url: {
        type: String,
        computed: '_processEventUrl(username)'
      },
      events_params: {
        type: String,
        computed: '_processEventParams(page, per_page)'
      },
      events: {
        type: Object,
        value: [{date: "hola"},{date: "adios"}],
        observer: 'eventChanged'
      }
    },

    attached : function() {
      if (this.token != '') {
        this.$.request.headers = '{"Authorization":"token '+this.token+'"}';
      }
      // Call Github Api
      if (this.username) {
        if(this.language == 'es'){
          this.idioma = 'es_es.json'
        }else if(this.language == 'en'){
          this.idioma = 'en_en.json'
        }
        this.$.requestLanguage.generateRequest();
      }
    },
    _response: function(event,detail){
      // Github events
/*      this.events = this.changeEvent(detail.response);
      // Check lastPage
      if (this.lastPage == '') {
        var headers = detail.xhr.getAllResponseHeaders();
        headers = headers.split(",");
        var head = headers[headers.length-1];
        var patron = 'page'+'=([^&]*)';
        var exp = new RegExp(patron);
        this.lastPage = parseInt(exp.exec(head)[1]);
      }
      var t = this.$.contenido;
      t.events == undefined ? t.events = this.events:	t.events = 	t.events.concat(this.events);

      this.show = false;
      // If not lastPage, next request is the next page
      if (this.page != this.lastPage)
        this.page++;*/
    },

    _language_response: function(event, detail){
      this.language_data = detail.response;
      if(!this.events){
        this.$.request.generateRequest();
      }
      else{
        this.events = this.changeEvent(this.events)
        var t = this.$.contenido;
        t.events = this.events;
      }
    },

    _languageChanged: function(oldVal, newVal){
      if(newVal === "en" && attrName == "language"){
        this.language = "en";
        this.idioma = "en_en.json"
        this.$.requestLanguage.generateRequest();
      }
      else if(newVal === "es" && attrName == "language"){
        this.language = "es";
        this.idioma = "es_es.json"
        this.$.requestLanguage.generateRequest();
      }
    },

    load: function(){
      this.$.request.generateRequest();
    },

    refresh: function(){
      this.events = this.changeEvent(this.events);
    },

    changeEvent: function(list){
      for (i=0;i<list.length;i++){
        switch(list[i].type) {
          case "PushEvent":
            list[i].operation = this.language_data.push;
            if (list[i].info) {
              list[i].info = "Commit: \n "+list[i].payload.commits[0].message;
            };
            break;
          case "WatchEvent":
            list[i].operation = this.language_data.follow;
            break;
          case "CreateEvent":
            list[i].operation = this.language_data.create;
            break;
          case "PullRequestEvent":
            list[i].operation = this.language_data.pull_request;
            break;
          case "IssuesEvent":
            break;
          case "MemberEvent":
            break;
          case "ReleaseEvent":
            break;
          case "CommitCommentEvent":
            break;
          case "DelateEvent":
            break;
          case "GollumEvent":
            break;
          case "IssueCommentEvent":
            break;
          case "PublicEvent":
            break;
          case "PullRequestReviewCommentEvent":
            break;
        };
        var date = new Date(list[i].created_at);
        var month = [this.language_data.january,this.language_data.february,this.language_data.march,this.language_data.april, this.language_data.may,this.language_data.june,this.language_data.july,this.language_data.august,this.language_data.september,this.language_data.october,this.language_data.november,this.language_data.december];
        list[i].date =this.language_data.date+date.getDate()+ this.language_data.of +month[date.getMonth()]+this.language_data.of+date.getFullYear();
      }
      return list;
    },



    // Proces
    _processUrl: function(idioma) {
      return "language/" + idioma; 
    },
    _processEventUrl: function(username) {
      return "https://api.github.com/users/" + username + "/received_events";
    },
    _processEventParams: function(page, per_page) {
      return {"page": page,"per_page": per_page}
    },
    eventChanged: function(newValue, oldValue) {
      console.log(newValue); 
    }
  });
</script>
</dom-module>
